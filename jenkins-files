pipeline {
    agent any    
    stages {          
         stage('docker build') {
             steps {
                sh "docker build -t gcr.io/vodacast-staging/vodacastgithubaction:1.0 ."
         }
         }          
        stage('docker push') {
             steps {
                 withCredentials([file(credentialsId: 'gcr', variable: 'GC_KEY')]){
              sh "cat '$GC_KEY' | docker login -u _json_key --password-stdin https://gcr.io"
              sh "gcloud auth activate-service-account --key-file='$GC_KEY'"
              sh "gcloud auth configure-docker"
              echo "Pushing image To GCR"
              sh "docker push gcr.io/vodacast-staging/vodacastgithubaction:1.0"
          }
             }
                        }
            
        stage('deploy in kubernetes') {
             steps {
               sh "gcloud run deploy vodacastapigithubaction --image gcr.io/vodacast-staging/vodacastgithubaction:1.0 ."           
                           
         }          
  }
}
}
}
